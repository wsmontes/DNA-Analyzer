<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DNA Explorer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --accent: #4cc9f0;
      --success: #0cce6b;
      --warning: #fca311;
      --danger: #e63946;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #dee2e6;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 8px;
      --transition: all 0.2s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: #fbfbfd;
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 20px;
    }

    header {
      background: #fff;
      padding: 16px 0;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      margin-bottom: 24px;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--primary);
    }

    .logo h1 {
      font-size: 1.6rem;
      font-weight: 600;
      margin: 0;
    }

    .logo span {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      font-weight: bold;
      font-size: 20px;
    }

    .upload-area {
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 32px;
      text-align: center;
      margin-bottom: 24px;
      border: 2px dashed var(--gray-light);
    }

    .upload-area.dragover {
      border-color: var(--primary);
      background: rgba(67, 97, 238, 0.05);
    }

    .upload-area h2 {
      margin-bottom: 16px;
      font-weight: 500;
      color: var(--dark);
    }

    .upload-area p {
      color: var(--gray);
      margin-bottom: 24px;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }

    .file-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 20px;
      border-radius: var(--radius);
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: var(--transition);
      text-decoration: none;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--secondary);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--gray-light);
      color: var(--gray);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.9rem;
    }

    #loading {
      display: none;
      padding: 16px;
      border-radius: var(--radius);
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
      margin: 16px 0;
      text-align: center;
      font-weight: 500;
    }

    .section {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 24px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 1.4rem;
      font-weight: 600;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }

    .dashboard-card {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      text-align: center;
      transition: var(--transition);
      border: 1px solid var(--gray-light);
    }

    .dashboard-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .dashboard-card .number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .dashboard-card .label {
      color: var(--gray);
      font-weight: 500;
    }

    .insights-wrapper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
    }

    .insight-item {
      background: white;
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      border-left: 4px solid var(--primary-light);
    }

    .insight-item:last-child {
      margin-bottom: 0;
    }

    .tab-container {
      margin-bottom: 24px;
    }

    .tab-bar {
      display: flex;
      overflow-x: auto;
      border-bottom: 2px solid var(--gray-light);
      margin-bottom: 16px;
    }

    .tab-btn {
      background: transparent;
      border: none;
      padding: 12px 24px;
      font-weight: 500;
      cursor: pointer;
      color: var(--gray);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: var(--transition);
      white-space: nowrap;
    }

    .tab-btn:hover {
      color: var(--primary);
    }

    .tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab-content {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .tab-panel {
      display: none;
      padding: 24px;
    }

    .tab-panel.active {
      display: block;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 10px 16px;
      border: 1px solid var(--gray-light);
      border-radius: var(--radius);
      font-size: 1rem;
      transition: var(--transition);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }

    select {
      padding: 10px 16px;
      border: 1px solid var(--gray-light);
      border-radius: var(--radius);
      background: white;
      font-size: 1rem;
      min-width: 180px;
      transition: var(--transition);
    }

    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--gray-light);
    }

    th {
      background: rgba(67, 97, 238, 0.05);
      font-weight: 600;
      color: var(--dark);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tbody tr {
      transition: var(--transition);
    }

    tbody tr:hover {
      background: rgba(67, 97, 238, 0.05);
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      gap: 8px;
    }

    .pagination button {
      background: white;
      border: 1px solid var(--gray-light);
      border-radius: var(--radius);
      padding: 8px 16px;
      cursor: pointer;
      transition: var(--transition);
    }

    .pagination button:hover:not(:disabled) {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .clin-pathogenic {
      color: var(--danger);
      font-weight: 600;
    }

    .clin-benign {
      color: var(--success);
    }

    .clin-uncertain {
      color: var(--warning);
    }

    .trait-keyword {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
      border-radius: 20px;
      padding: 2px 10px;
      margin-right: 6px;
      font-size: 0.9rem;
      display: inline-block;
      margin-bottom: 4px;
    }

    .tooltip {
      position: relative;
      display: inline-block;
      border-bottom: 1px dotted var(--gray);
      cursor: help;
    }

    .tooltip:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--dark);
      color: white;
      padding: 8px 12px;
      border-radius: var(--radius);
      font-size: 0.9rem;
      white-space: nowrap;
      z-index: 100;
    }

    .snp-link {
      color: var(--primary);
      text-decoration: none;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }

    .snp-link:hover {
      text-decoration: underline;
      color: var(--secondary);
    }

    .details-card {
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background: white;
      padding: 24px;
      margin-top: 24px;
    }

    .details-card h2 {
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .details-card h3 {
      margin: 20px 0 12px;
      font-weight: 600;
      color: var(--primary);
      font-size: 1.1rem;
    }

    .details-card ul {
      margin-left: 20px;
    }

    .details-card strong {
      font-weight: 600;
    }

    .external-links {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .external-links a {
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
      transition: var(--transition);
    }

    .external-links a:hover {
      background: var(--primary);
      color: white;
    }

    details summary {
      cursor: pointer;
      padding: 12px;
      background: rgba(67, 97, 238, 0.05);
      border-radius: var(--radius);
      margin: 16px 0;
      font-weight: 500;
    }

    details pre {
      background: #f8f9fa;
      padding: 16px;
      border-radius: var(--radius);
      overflow: auto;
      max-height: 500px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 0 12px;
      }

      .header-content {
        flex-direction: column;
        gap: 12px;
      }

      .dashboard {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .insights-wrapper {
        grid-template-columns: 1fr;
      }

      .filters {
        flex-direction: column;
      }

      .search-input, select {
        width: 100%;
      }

      .external-links {
        flex-direction: column;
      }
    }

    /* Loading animations */
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(67, 97, 238, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      to {transform: rotate(360deg);}
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <a href="#" class="logo">
        <span>DNA</span>
        <h1>DNA Explorer</h1>
      </a>
    </div>
  </header>

  <main class="container">
    <div class="upload-area" id="uploadArea">
      <h2>Upload Your DNA Data</h2>
      <p>Upload your MyHeritage DNA ZIP file to begin analysis</p>
      <div class="file-input-wrapper">
        <button class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
            <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
          </svg>
          Select DNA File
        </button>
        <input type="file" id="fileInput" accept=".zip" class="file-input" />
      </div>
    </div>

    <div id="loading">
      <span class="spinner"></span>
      Processing DNA data...
    </div>

    <section id="dashboard" class="dashboard section" style="display: none;"></section>

    <section id="insightSection" class="section" style="display: none;">
      <div class="section-header">
        <h2 class="section-title">Key Insights</h2>
      </div>
      <div class="insights-wrapper">
        <div id="insights"></div>
        <div id="traits"></div>
      </div>
    </section>
    
    <div class="section" id="dataSection" style="display: none;">
      <div class="section-header">
        <h2 class="section-title">DNA Data Analysis</h2>
        <button id="downloadBtn" class="btn btn-outline">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
          </svg>
          Download Report
        </button>
      </div>
      
      <div class="filters">
        <input type="text" id="searchInput" placeholder="Search by rsID..." class="search-input" />
        <select id="chromFilter">
          <option value="">All chromosomes</option>
        </select>
      </div>

      <div class="tab-container">
        <div class="tab-bar" id="tab-bar">
          <button class="tab-btn active" data-tab="table">All SNPs</button>
          <button class="tab-btn" data-tab="traits">Health & Traits</button>
          <button class="tab-btn" data-tab="charts">Charts</button>
        </div>
        
        <div class="tab-content">
          <div id="table" class="tab-panel active"></div>
          <div id="traits" class="tab-panel"></div>
          <div id="charts" class="tab-panel">
            <canvas id="genoChart" width="600" height="300"></canvas>
          </div>
        </div>
      </div>
      
      <div id="pagination" class="pagination"></div>
    </div>

    <div id="details" class="details-card" style="display: none;"></div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Setup drag and drop for upload area
      const uploadArea = document.getElementById('uploadArea');
      
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        if (e.dataTransfer.files.length) {
          document.getElementById('fileInput').files = e.dataTransfer.files;
          // Trigger the change event manually
          const event = new Event('change');
          document.getElementById('fileInput').dispatchEvent(event);
        }
      });
    });

    const loadingEl = document.getElementById('loading');
    const tableContainer = document.getElementById('table');
    const paginationEl = document.getElementById('pagination');
    const detailsEl = document.getElementById('details');
    const searchInput = document.getElementById('searchInput');
    const chromFilter = document.getElementById('chromFilter');
    const downloadBtn = document.getElementById('downloadBtn');
    const dashboardEl = document.getElementById('dashboard');
    const insightsEl = document.getElementById('insights');
    const insightSection = document.getElementById('insightSection');
    const dataSection = document.getElementById('dataSection');
    const traitsEl = document.getElementById('traits');
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');

    // Tab switching logic
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        tabPanels.forEach(panel => panel.classList.remove('active'));
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    // Proxy manager: Tests upfront, saves the first working proxy
    const proxyManager = {
      proxies: [
        { url: '',                                name: 'Direct' },
        { url: 'https://api.allorigins.win/raw?url=',     name: 'AllOrigins' },
        { url: 'https://api.allorigins.cf/raw?url=',      name: 'AllOrigins.cf' },
        { url: 'https://api.allorigins.dev/raw?url=',     name: 'AllOrigins.dev' },
        { url: 'https://allorigins.herokuapp.com/raw?url=',name: 'AllOriginsHeroku' },
        { url: 'https://api.allorigins.live/raw?url=',    name: 'AllOrigins.live' },
        { url: 'https://api.allorigins.xyz/raw?url=',     name: 'AllOrigins.xyz' },
        { url: 'https://corsproxy.io/?',                  name: 'CORSProxy.io' },
        { url: 'https://thingproxy.freeboard.io/fetch/',  name: 'ThingProxy' },
        { url: 'https://jsonp.afeld.me/?url=',            name: 'jsonp.afeld' },
        { url: 'https://yacdn.org/proxy/',                 name: 'YACDN' },
        { url: 'https://crossorigin.me/',                  name: 'CrossOrigin.me' },
        { url: 'https://cors-anywhere.herokuapp.com/',     name: 'CORS-Anywhere' },
        { url: 'https://cors.bridged.cc/',                 name: 'Bridged.CC' },
        { url: 'https://cors.sh/',                         name: 'CORS.sh' },
        { url: 'https://proxy.it.usecors.com/',            name: 'UseCORS' },
        { url: 'https://cors.lol/',                        name: 'CORS.lol' },
        { url: 'https://corsproxy.netlify.app/?url=',      name: 'NetlifyCORS' },
        { url: 'https://cors.jax.io/?u=',                  name: 'JAX.CORS' },
        { url: 'https://cors-proxy.htmldriven.com/?url=',  name: 'HTMLDriven' },
        { url: 'https://jsonp.nodeflix.dev/?url=',         name: 'NodeFlix' },
        { url: 'https://gimmeproxy.com/api/proxy?url=',    name: 'GimmeProxy' }
      ],
      currentProxy: null, // Stores the first working proxy found
      isInitialized: false,
      isInitializing: false,
      cache: new Map(),

      // Log with visual distinction
      log(message, type = 'info') {
        const styles = {
          info: 'color: #2196F3; font-weight: bold;',
          success: 'color: #4CAF50; font-weight: bold;',
          error: 'color: #F44336; font-weight: bold;',
          warning: 'color: #FF9800; font-weight: bold;'
        };
        console.log(`%c[ProxyManager] ${message}`, styles[type] || styles.info);
      },

      // Initialize: Test proxies and find the first working one
      async initialize() {
        if (this.isInitialized || this.isInitializing) {
          return this.isInitialized;
        }
        this.isInitializing = true;
        this.log('Initializing: Testing proxies...');

        const testUrl = 'https://rest.ensembl.org/info/ping?content-type=application/json';

        for (let i = 0; i < this.proxies.length; i++) {
          const proxy = this.proxies[i];
          const fullUrl = proxy.url ? `${proxy.url}${encodeURIComponent(testUrl)}` : testUrl;
          this.log(`Testing proxy: ${proxy.name}...`);
          try {
            const response = await fetch(fullUrl, {
              method: 'GET',
              headers: { 'Accept': 'application/json' },
              signal: AbortSignal.timeout(5000) // 5 second timeout
            });

            if (response.ok) {
              this.log(`Success! Using proxy: ${proxy.name}`, 'success');
              this.currentProxy = proxy;
              this.isInitialized = true;
              this.isInitializing = false;
              return true; // Found a working proxy
            } else {
              this.log(`${proxy.name} responded but with status: ${response.status}`, 'warning');
            }
          } catch (error) {
            this.log(`${proxy.name} failed: ${error.message}`, 'error');
          }
        }

        this.log('Initialization failed: No working proxy found.', 'error');
        this.isInitializing = false;
        return false; // No working proxy found
      },

      // Check cache
      isCached(url) {
        return this.cache.has(url);
      },
      getFromCache(url) {
        return this.cache.get(url);
      },
      saveToCache(url, data, ttl = 3600000) {
        this.cache.set(url, {
          data,
          expires: Date.now() + ttl
        });

        // Cleanup expired items occasionally
        if (Math.random() < 0.1) { // 10% chance to trigger cleanup
          this.cleanCache();
        }
      },
      cleanCache() {
        const now = Date.now();
        for (const [url, cached] of this.cache.entries()) {
          if (cached.expires < now) {
            this.cache.delete(url);
          }
        }
      },

      // Fetch using the pre-determined working proxy, with one retry on failure
      async fetch(url, options = {}, _retried = false) {
        // ensure initialization
        if (!this.isInitialized) {
          if (!this.isInitializing) await this.initialize();
          else {
            await new Promise(r => {
              const iv = setInterval(() => { if (!this.isInitializing) { clearInterval(iv); r(); } }, 100);
            });
          }
          if (!this.currentProxy) throw new Error("No working proxy available.");
        }

        // cache check omitted for brevity...

        const proxy = this.currentProxy;
        const fullUrl = proxy.url ? `${proxy.url}${encodeURIComponent(url)}` : url;

        try {
          this.log(`Fetching via ${proxy.name}: ${url.slice(0,50)}…`);
          const response = await fetch(fullUrl, {
            ...options,
            signal: AbortSignal.timeout(8000)
          });
          if (!response.ok) throw new Error(`Status ${response.status}`);
          const data = await response.clone().json();
          this.saveToCache(url, data);
          this.log(`Success with ${proxy.name}`, 'success');
          return response;
        } catch (err) {
          this.log(`${proxy.name} failed: ${err.message}`, 'error');
          // on first failure, forget this proxy, re-init and retry once
          if (!_retried) {
            this.isInitialized = false;
            this.currentProxy = null;
            this.log('Retrying fetch with new proxy…', 'warning');
            await this.initialize();
            return this.fetch(url, options, true);
          }
          throw err;
        }
      }
    };

    // Data manager remains largely the same, relying on proxyManager.fetch
    const dataManager = {
      snpCache: new Map(),

      // Get cached SNP data if available
      getCachedSnp(rsid) {
        return this.snpCache.get(rsid);
      },

      // Set SNP in cache
      cacheSnp(rsid, data) {
        this.snpCache.set(rsid, data);
      },

      // Fetch SNP details only when needed
      async fetchSnp(rsid) {
        // Check cache first
        const cached = this.getCachedSnp(rsid);
        if (cached) {
          return cached;
        }

        const url = `https://rest.ensembl.org/variation/human/${rsid}?content-type=application/json`;
        try {
          // Use the updated proxyManager.fetch
          const res = await proxyManager.fetch(url, {
            headers: { 'Accept': 'application/json' }
          });

          const data = await res.json();
          this.cacheSnp(rsid, data);
          return data;
        } catch (err) {
          console.error(`Error fetching ${rsid}:`, err);
          throw err;
        }
      }
    };

    let allResults = [];
    let filteredResults = [];
    let currentPage = 1;
    const rowsPerPage = 20;
    let tableEl = null;
    let clinSummary = [];
    let traitSummary = [];

    document.getElementById('fileInput').addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;

      // Reset UI
      loadingEl.style.display = 'block';
      loadingEl.innerHTML = '<span class="spinner"></span> Processing file...';
      dashboardEl.innerHTML = '';
      dashboardEl.style.display = 'none';
      insightsEl.innerHTML = '';
      insightSection.style.display = 'none';
      dataSection.style.display = 'none';
      document.getElementById('summary')?.remove();
      tableContainer.innerHTML = '';
      paginationEl.innerHTML = '';
      document.getElementById('charts').innerHTML = '<canvas id="genoChart" width="600" height="300"></canvas>';
      detailsEl.innerHTML = '';
      detailsEl.style.display = 'none';
      searchInput.value = '';
      chromFilter.value = '';
      chromFilter.innerHTML = '<option value="">All chromosomes</option>';
      traitsEl.innerHTML = '';

      try {
        const data = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(data);
        const csvName = Object.keys(zip.files).find(n => n.endsWith('.csv'));
        if (!csvName) throw new Error("No CSV file found in the ZIP.");
        const csvText = await zip.files[csvName].async('text');
        const cleanedCsvText = csvText.split('\n').filter(line => !line.startsWith('#')).join('\n');
        const parseResult = Papa.parse(cleanedCsvText, { header: true, skipEmptyLines: true });

        // Find headers
        const headers = parseResult.meta.fields.map(h => h.toLowerCase());
        const rsidHeader = parseResult.meta.fields[headers.indexOf('rsid')] || parseResult.meta.fields[headers.indexOf('rs#')];
        const chromHeader = parseResult.meta.fields[headers.indexOf('chromosome')];
        const posHeader = parseResult.meta.fields[headers.indexOf('position')];
        const genoHeader = parseResult.meta.fields[headers.indexOf('genotype')] || parseResult.meta.fields[headers.indexOf('result')];

        if (!rsidHeader || !chromHeader || !posHeader || !genoHeader) {
            throw new Error(`Could not find required columns. Detected headers: ${parseResult.meta.fields.join(', ')}. Required (case-insensitive): rsid/rs#, chromosome, position, genotype/result.`);
        }

        allResults = parseResult.data
            .filter(r => r[rsidHeader] && r[chromHeader] && r[posHeader] && r[genoHeader])
            .map(r => ({
                rsid: r[rsidHeader],
                chromosome: r[chromHeader],
                position: r[posHeader],
                Genotype: r[genoHeader]
            }));

        filteredResults = [...allResults];

        if (allResults.length === 0) {
            throw new Error("No valid SNP data rows found after filtering. Check CSV content and headers.");
        }

        // --- Initialize Proxy Manager (crucial step) ---
        loadingEl.innerHTML = '<span class="spinner"></span> Initializing connections...';
        const proxyReady = await proxyManager.initialize();
        if (!proxyReady) {
            // Optionally inform the user more gracefully
            alert("Could not establish a connection to external APIs. Some features might be limited.");
            // Decide if you want to proceed without API access or stop
        }

        // --- Evaluate and summarize important findings (using the initialized proxy) ---
        clinSummary = [];
        traitSummary = [];
        let clinCounts    = { pathogenic:0, likely_pathogenic:0, benign:0, uncertain:0, other:0 };
        let traitCounts   = {};
        let ancestryHints = 0;
        let topInsights   = [];

        // We'll only analyze a sample of SNPs initially, then fetch more on demand
        const snpsToSample = allResults.slice(0,50); 

        // Helper: extract trait/health keywords
        function extractTraits(info) {
          const keywords = ['height','eye color','hair','lactose','alcohol','caffeine','diabetes','cancer','asthma','skin','obesity','blood','cholesterol','alzheimer','parkinson','celiac','crohn','sickle','thalassemia','hemochromatosis','ancestry','ethnicity','risk','disease','trait','response','drug','immunity','autoimmune'];
          let found = [];
          if (info?.phenotypes) {
            for (const ph of info.phenotypes) {
              for (const k of keywords) {
                if (ph.description && ph.description.toLowerCase().includes(k)) found.push(k);
              }
            }
          }
          return [...new Set(found)];
        }

        // Fetch and analyze a sample first
        loadingEl.innerHTML = '<span class="spinner"></span> Analyzing a sample of SNPs...';

        for (const snp of snpsToSample) {
          try {
            const info = await dataManager.fetchSnp(snp.rsid);
            
            // Clinical significance
            let clin = (info.clinical_significance || []).map(x => x.toLowerCase());
            if (clin.includes('pathogenic')) clinCounts.pathogenic++;
            else if (clin.includes('likely pathogenic')) clinCounts.likely_pathogenic++;
            else if (clin.includes('benign')) clinCounts.benign++;
            else if (clin.includes('uncertain significance')) clinCounts.uncertain++;
            else clinCounts.other++;

            if (clin.length > 0) {
              clinSummary.push({
                rsid: snp.rsid,
                clin,
                gene: info.mapped_genes?.[0]?.gene_symbol || '',
                desc: info.most_severe_consequence || '',
                phenotypes: info.phenotypes || []
              });
            }

            // Traits
            const traits = extractTraits(info);
            if (traits.length > 0) {
              traitSummary.push({
                rsid: snp.rsid,
                traits,
                gene: info.mapped_genes?.[0]?.gene_symbol || '',
                desc: info.most_severe_consequence || '',
                phenotypes: info.phenotypes || []
              });
              for (const t of traits) traitCounts[t] = (traitCounts[t] || 0) + 1;
            }

            // Ancestry hints
            if (traits.includes('ancestry') || traits.includes('ethnicity')) ancestryHints++;
            
          } catch (err) {
            // Just continue with the next SNP
            console.warn(`Skipping analysis for ${snp.rsid}:`, err.message);
          }
        }

        // Show the dashboard and sections
        dashboardEl.style.display = 'block';
        insightSection.style.display = 'block';
        dataSection.style.display = 'block';

        // Top insights
        if (clinCounts.pathogenic > 0) topInsights.push(`<span class="clin-pathogenic">${clinCounts.pathogenic} pathogenic SNPs detected</span>`);
        if (clinCounts.likely_pathogenic > 0) topInsights.push(`<span class="clin-pathogenic">${clinCounts.likely_pathogenic} likely pathogenic SNPs</span>`);
        if (Object.keys(traitCounts).length > 0) {
          const topTraits = Object.entries(traitCounts).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k,v])=>`${k} (${v})`);
          topInsights.push(`Traits detected: <span class="trait-keyword">${topTraits.join('</span>, <span class="trait-keyword">')}</span>`);
        }
        if (ancestryHints > 0) topInsights.push(`${ancestryHints} ancestry/ethnicity-related SNPs found`);

        // --- Dashboard ---
        dashboardEl.innerHTML = `
          <div class="dashboard-card">
            <div class="number">${allResults.length.toLocaleString()}</div>
            <div class="label">Total SNPs</div>
          </div>
          <div class="dashboard-card">
            <div class="number">${(clinCounts.pathogenic + clinCounts.likely_pathogenic)}</div>
            <div class="label">Potentially Pathogenic</div>
          </div>
          <div class="dashboard-card">
            <div class="number">${Object.keys(traitCounts).length}</div>
            <div class="label">Traits/Phenotypes</div>
          </div>
          <div class="dashboard-card">
            <div class="number">${ancestryHints}</div>
            <div class="label">Ancestry Markers</div>
          </div>
        `;

        // --- Insights ---
        insightsEl.innerHTML = `
          <h3>Top Insights</h3>
          ${topInsights.length ? topInsights.map(i=>`<div class="insight-item">${i}</div>`).join('') : '<div class="insight-item">No high-priority findings in first 50 SNPs.</div>'}
          <div style="margin-top:10px;font-size:0.9em;color:var(--gray);">(Click a SNP in the table for more details. Only first 50 SNPs are deeply analyzed for speed.)</div>
        `;

        // --- Traits/Health Tab ---
        let traitHtml = '';
        if (traitSummary.length) {
          traitHtml += `<h3>Health & Traits</h3>`;
          traitHtml += `<table><thead><tr><th>rsID</th><th>Gene</th><th>Traits</th><th>Phenotypes</th></tr></thead><tbody>`;
          for (const t of traitSummary) {
            traitHtml += `<tr>
              <td><span class="snp-link" onclick="fetchDetails('${t.rsid}')">${t.rsid}</span></td>
              <td>${t.gene}</td>
              <td>${t.traits.map(tr=>`<span class="trait-keyword">${tr}</span>`).join('')}</td>
              <td>${t.phenotypes.map(p=>p.description).join('; ')}</td>
            </tr>`;
          }
          traitHtml += `</tbody></table>`;
        } else {
          traitHtml = `<div>No trait/phenotype associations found in first 50 SNPs.</div>`;
        }
        traitsEl.innerHTML = traitHtml;

        // --- Table and rest of UI ---
        // Basic summary (uses normalized keys now)
        const total = allResults.length;
        const homo = allResults.filter(r => r.Genotype && ( (r.Genotype.length === 3 && r.Genotype[0] === r.Genotype[2]) || (r.Genotype.length === 2 && r.Genotype[0] === r.Genotype[1]) ) ).length;
        const hetero = total - homo;

        tableEl = document.createElement('table');
        tableEl.innerHTML = `<thead><tr><th>rsID</th><th>Chromosome</th><th>Position</th><th>Genotype</th></tr></thead><tbody></tbody>`;
        tableContainer.innerHTML = '';
        tableContainer.append(tableEl);

        // Populate chromosome filter
        const chroms = [...new Set(allResults.map(r => r.chromosome))].sort((a, b) => {
            const na = parseInt(a); const nb = parseInt(b);
            if (!isNaN(na) && !isNaN(nb)) return na - nb;
            if (!isNaN(na)) return -1; if (!isNaN(nb)) return 1;
            return a.localeCompare(b);
        });
        chroms.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c; opt.textContent = `Chromosome ${c}`;
          chromFilter.append(opt);
        });

        currentPage = 1;
        renderTablePage();
        setupPagination();

        // Chart of geno counts
        const genoChartCtx = document.getElementById('genoChart').getContext('2d');
        new Chart(genoChartCtx, {
          type: 'pie',
          data: {
            labels: ['Homozygous (approx)', 'Heterozygous (approx)'],
            datasets: [{ 
              data: [homo, hetero], 
              backgroundColor: ['#4361ee', '#4cc9f0'],
              borderColor: 'white',
              borderWidth: 2
            }]
          },
          options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20
                }
              }
            }
          }
        });

        searchInput.addEventListener('input', handleFilterChange);
        chromFilter.addEventListener('change', handleFilterChange);
        downloadBtn.addEventListener('click', downloadReport);

      } catch (error) {
        dashboardEl.innerHTML = '';
        dashboardEl.style.display = 'none';
        insightsEl.innerHTML = '';
        insightSection.style.display = 'none';
        dataSection.style.display = 'none';
        detailsEl.style.display = 'none';
        
        // Show error in a nice way
        document.body.insertAdjacentHTML('beforeend', `
          <div class="section" style="text-align:center;margin-top:40px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#e63946" viewBox="0 0 16 16">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
            </svg>
            <h2 style="margin:20px 0">Error Processing DNA File</h2>
            <p style="color:var(--danger)">${error.message}</p>
            <button class="btn btn-primary" style="margin-top:20px;" onclick="location.reload()">Try Again</button>
          </div>
        `);
      } finally {
        loadingEl.style.display = 'none';
      }
    });

    function handleFilterChange() {
        const q = searchInput.value.toLowerCase();
        const cf = chromFilter.value;
        filteredResults = allResults.filter(r => {
            const rsidMatch = !q || r.rsid.toLowerCase().includes(q);
            const chromMatch = !cf || r.chromosome === cf;
            return rsidMatch && chromMatch;
        });
        currentPage = 1;
        renderTablePage();
        setupPagination();
    }

    function renderTablePage() {
        if (!tableEl) return;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = filteredResults.slice(start, end);

        const tbody = tableEl.querySelector('tbody');
        tbody.innerHTML = pageData.map(r => `
            <tr data-rsid="${r.rsid}" style="cursor:pointer;">
              <td><span class="snp-link" onclick="fetchDetails('${r.rsid}')">${r.rsid}</span></td>
              <td>${r.chromosome}</td>
              <td>${r.position}</td>
              <td>${r.Genotype}</td>
            </tr>`).join('');

        // Add click listeners to new rows (for keyboard accessibility)
        tbody.querySelectorAll('tr[data-rsid]').forEach(row => {
            row.addEventListener('click', (e) => {
                // Don't trigger if they clicked directly on the link
                if (!e.target.classList.contains('snp-link')) {
                    fetchDetails(row.dataset.rsid);
                }
            });
        });
    }

    function setupPagination() {
        paginationEl.innerHTML = '';
        const totalPages = Math.ceil(filteredResults.length / rowsPerPage);

        if (totalPages <= 1) return;

        const prevButton = document.createElement('button');
        prevButton.textContent = 'Previous';
        prevButton.disabled = currentPage === 1;
        prevButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTablePage();
                setupPagination();
            }
        });
        paginationEl.appendChild(prevButton);

        const pageInfo = document.createElement('span');
        pageInfo.textContent = ` Page ${currentPage} of ${totalPages} `;
        pageInfo.style.margin = '0 10px';
        paginationEl.appendChild(pageInfo);

        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next';
        nextButton.disabled = currentPage === totalPages;
        nextButton.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderTablePage();
                setupPagination();
            }
        });
        paginationEl.appendChild(nextButton);
    }

    function downloadReport() {
        if (allResults.length === 0) {
            alert("No data loaded to download.");
            return;
        }
        const dataToDownload = allResults;
        const blob = new Blob([JSON.stringify(dataToDownload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'dna_report.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Make fetchDetails globally accessible
    window.fetchDetails = fetchDetails;

    async function fetchDetails(rsid) {
      detailsEl.style.display = 'block';
      detailsEl.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;">
          <span class="spinner"></span>
          <p>Loading details for ${rsid}…</p>
        </div>
      `;
      
      // Scroll to details
      detailsEl.scrollIntoView({behavior: 'smooth'});
      
      let ensemblInfo = {};
      let popFreq = {};
      let snpediaSummary = 'Could not fetch SNPedia summary.';
      let errorMessages = [];

      try {
          // Use dataManager which uses the initialized proxy
          ensemblInfo = await dataManager.fetchSnp(rsid);
      } catch (err) {
          errorMessages.push(`Failed to fetch Ensembl variation data: ${err.message}`);
      }

      // Fetch population frequencies (also uses proxyManager.fetch)
      if (ensemblInfo.name) {
           try {
              const url = `https://rest.ensembl.org/variation/human/${rsid}?pops=1;content-type=application/json`;
              const pfRes = await proxyManager.fetch(url, {
                headers: { 'Accept': 'application/json' }
              });
              const pfData = await pfRes.json();
              if (pfData.populations) {
                   popFreq = pfData.populations.reduce((acc, p) => {
                      acc[p.population] = p.frequency !== undefined ? p.frequency.toFixed(4) : 'N/A';
                      return acc;
                  }, {});
              } else {
                   popFreq = { 'Info': 'No population data available.' };
              }
          } catch (err) {
              errorMessages.push(`Failed to fetch population frequencies: ${err.message}`);
              popFreq = { 'Error': 'Could not load data.' };
          }
      } else {
           popFreq = { 'Info': 'Skipped due to variation fetch error.' };
      }

      // Fetch SNPedia summary (direct fetch, no proxy needed)
      try {
          // Wikipedia API already supports CORS, so no proxy needed
          const spRes = await fetch(`https://en.wikipedia.org/w/api.php?` +
              new URLSearchParams({
                  action: 'query', prop: 'extracts', format: 'json',
                  titles: rsid, origin: '*', exintro: '', explaintext: ''
              }));
          if (!spRes.ok) throw new Error(`Wikipedia API error (${spRes.status})`);
          const wpData = await spRes.json();
          const pages = wpData.query?.pages || {};
          const page = Object.values(pages)[0];
          if (page && !page.missing && page.extract) {
              snpediaSummary = page.extract;
          } else {
               snpediaSummary = 'No SNPedia article found or summary available.';
          }
      } catch (err) {
          errorMessages.push(`Failed to fetch SNPedia summary: ${err.message}`);
      }

      // --- Display results ---
      const clinicalSignificance = (ensemblInfo.clinical_significance || []).join(', ') || 'none';
      const popFreqHtml = Object.entries(popFreq).length > 0 
        ? Object.entries(popFreq).map(([pop, freq]) => `<li>${pop}: ${freq}</li>`).join('') 
        : '<li>No population data available</li>';
      const phenotypesHtml = (ensemblInfo.phenotypes || []).length > 0
        ? (ensemblInfo.phenotypes || []).map(p => `<li>${p.description}</li>`).join('')
        : '<li>No phenotype data available</li>';

      // Display which proxy is being used (if any)
      let proxyInfo = '<span style="font-size:0.9em;color:var(--gray)">Proxy status: Not initialized</span>';
      if (proxyManager.isInitialized && proxyManager.currentProxy) {
          proxyInfo = proxyManager.currentProxy.url
            ? `<span style="font-size:0.9em;color:var(--gray)">Using: ${proxyManager.currentProxy.name} proxy</span>`
            : '<span style="font-size:0.9em;color:var(--gray)">Using: Direct API access</span>';
      }
      
      // Add clinical significance styling
      let clinicalClass = '';
      let clinText = clinicalSignificance;
      if (clinicalSignificance.includes('pathogenic')) {
        clinicalClass = 'clin-pathogenic';
      } else if (clinicalSignificance.includes('benign')) {
        clinicalClass = 'clin-benign';
      } else if (clinicalSignificance.includes('uncertain')) {
        clinicalClass = 'clin-uncertain';
      }

      detailsEl.innerHTML = `
          <h2>
            Details for ${rsid}
            <small>${proxyInfo}</small>
          </h2>
          
          ${errorMessages.length > 0 ? 
            `<div style="padding:12px;background:rgba(230,57,70,0.1);border-radius:var(--radius);margin-bottom:20px;">
               <strong>⚠️ Note:</strong> ${errorMessages.join('<br>')}
             </div>` : ''}
          
          <div class="external-links">
            <a href="https://www.snpedia.com/index.php/${rsid}" target="_blank">SNPedia</a>
            <a href="https://www.ncbi.nlm.nih.gov/snp/${rsid}" target="_blank">dbSNP</a>
            <a href="https://grch37.ensembl.org/Homo_sapiens/Variation/Summary?v=${rsid}" target="_blank">Ensembl</a>
          </div>
          
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:24px;margin-bottom:24px;">
            <div>
              <p><strong>Most Severe Consequence:</strong> ${ensemblInfo.most_severe_consequence || 'N/A'}</p>
              <p><strong>Ancestral Allele:</strong> ${ensemblInfo.ancestral_allele || 'N/A'}</p>
              <p><strong>Clinical Significance:</strong> <span class="${clinicalClass}">${clinText}</span></p>
              <p><strong>Mapped Gene:</strong> ${ensemblInfo.mapped_genes?.[0]?.gene_symbol || 'N/A'}</p>
            </div>
            <div>
              <p><strong>Minor Allele:</strong> ${ensemblInfo.minor_allele || 'N/A'}</p>
              <p><strong>MAF:</strong> ${ensemblInfo.MAF ? ensemblInfo.MAF.toFixed(4) : 'N/A'}</p>
              <p><strong>Assembly:</strong> ${ensemblInfo.assembly_name || 'N/A'}</p>
            </div>
          </div>

          <h3>Population Frequencies</h3>
          <ul class="freq-list">${popFreqHtml}</ul>
          
          <h3>Phenotypes</h3>
          <ul class="phenotype-list">${phenotypesHtml}</ul>
          
          <h3>SNPedia Summary</h3>
          <div style="padding:16px;background:#f8f9fa;border-radius:var(--radius);">${snpediaSummary.replace(/\n/g, '<br>')}</div>
          
          <details>
              <summary>Full Ensembl Variation JSON</summary>
              <pre>${JSON.stringify(ensemblInfo, null, 2)}</pre>
          </details>
      `;
    }
  </script>
</body>
</html>